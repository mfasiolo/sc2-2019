<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>3. Exercise on parallel local regression - SC2</title>
    <meta property="og:title" content="3. Exercise on parallel local regression - SC2">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="Here we consider an Irish smart meter data set which can be found in the electBook package. At the time of writing electBook is available only on Github, hence we need to install it from there using &amp;hellip;">
      <meta property="og:description" content="Here we consider an Irish smart meter data set which can be found in the electBook package. At the time of writing electBook is available only on Github, hence we need to install it from there using &amp;hellip;">
      
    

    
    

    

    
    


<link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="/sc2-2019/css/style.css" />
    <link rel="stylesheet" href="/sc2-2019/css/fonts.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Arvo">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Marcellus">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro">

<link rel="stylesheet" href="/sc2-2019/css/custom.css" />

<link rel="icon" href="/sc1-2019/favicon.ico" type="image/x-icon" />























<nav class="breadcrumbs">
    
        <a href="https://mfasiolo.github.io/sc2-2019/">home / </a>
    
        <a href="https://mfasiolo.github.io/sc2-2019/rcpp_advanced_iii/">rcpp_advanced_iii / </a>
    
        <a href="https://mfasiolo.github.io/sc2-2019/rcpp_advanced_iii/3_exercises/">3_exercises / </a>
    
</nav>

  </head>

  
  <body class="sc2-2019">
    <header class="masthead">
      <h1><a href="/sc2-2019/">SC2</a></h1>

<p class="tagline">Statistical Computing 2</p>

      <nav class="menu">
  <input id="menu-check" type="checkbox" />
  <label id="menu-label" for="menu-check" class="unselectable">
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li><a href="/sc2-2019/">Home</a></li>
  
  <li><a href="/sc2-2019/rcpp/">Integrating R and C</a></li>
  
  <li><a href="/sc2-2019/rcpp_advanced_i/">Advanced Rcpp I</a></li>
  
  <li><a href="/sc2-2019/rcpp_advanced_ii/">Advanced Rcpp II</a></li>
  
  <li><a href="/sc2-2019/rcpp_advanced_iii/">Parallel Rcpp</a></li>
  
  
  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>3. Exercise on parallel local regression</h1>

<h3>
</h3>
<hr>


      </header>





<div id="TOC">
<ul>
<li><a href="#smoothing-by-local-polynomial-regression">Smoothing by local polynomial regression</a></li>
</ul>
</div>

<style>
body {
text-align: justify}
</style>
<div id="smoothing-by-local-polynomial-regression" class="section level3">
<h3>Smoothing by local polynomial regression</h3>
<p>Here we consider an Irish smart meter data set which can be found in the <code>electBook</code> package. At the time of writing <code>electBook</code> is available only on Github, hence we need to install it from there using <code>devtools</code>:</p>
<pre class="r"><code># Install electBook only if it is not already installed
if( !require(electBook) ){
  library(devtools)
  install_github(&quot;mfasiolo/electBook&quot;)
  library(electBook)
}</code></pre>
<p>We can now load the data:</p>
<pre class="r"><code>library(electBook)
data(Irish)</code></pre>
<p>See <code>?Irish</code> or [<a href="https://awllee.github.io/sc1/tidyverse/data_reshaping_tidyr/" class="uri">https://awllee.github.io/sc1/tidyverse/data_reshaping_tidyr/</a>] for details about the data.
Let us concatenate the electricity demand from all households into a single vector:</p>
<pre class="r"><code>y &lt;- do.call(&quot;c&quot;, Irish$indCons)
y &lt;- y - mean(y)
str(y)
# Named num [1:44886928] -0.477 -0.366 -0.405 -0.476 -0.366 ...
# - attr(*, &quot;names&quot;)= chr [1:44886928] &quot;I10021&quot; &quot;I10022&quot; &quot;I10023&quot; &quot;I10024&quot; ...</code></pre>
<p>We have over 44 million observations, here we plot as sub-set:</p>
<pre class="r"><code>ncust &lt;- ncol(Irish$indCons) 

x &lt;- rep(Irish$extra$tod, ncust)

n &lt;- length(x)
ss &lt;- sample(1:n, 1e4)
plot(x[ss], y[ss], col = &quot;grey&quot;)</code></pre>
<p><img src="/sc2-2019/rcpp_advanced_III/3_Exercises_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>where the <span class="math inline">\(x\)</span>-axis here represents the time of day (0 is midnight and 47 is 23:30).</p>
<p>We want to model the relation between the time of day (<code>x</code>) and the demand (<code>y</code>). We start with a simple univariate regression model <span class="math inline">\(\mathbb{E}(y|x) = \beta_1 x\)</span> (note that we do not need an intercept as we have centered <code>y</code> above). Here is a simple function to fit the model by least squares:</p>
<pre class="r"><code>reg1D &lt;- function(y, x){
  
  b &lt;- t(x) %*% y / (t(x) %*% x)  
  
  return(b)
  
}</code></pre>
<p>Let’s compare this with the standard <code>lm()</code> function:</p>
<pre class="r"><code>system.time( lm(y ~ -1 + x)$coeff )[3]
11.518 

system.time( reg1D(y, x) )[3]
0.92</code></pre>
<p>Note that <code>lm</code> is much slower (probably because it computes many quantities that our function does not compute).</p>
<p><strong>Q1 start</strong> Implement a parallel version of <code>reg1D</code> using <code>RcppParallel</code>. You might
want use OpenMP and/or some of the functions provided by <code>RcppParallel</code> (e.g., <code>parallelReduce</code>) to parallelise you code. Make sure that you use thread-safe data structures. Compare your function to <code>reg1D</code> in terms of exactness and timing. <strong>Q1 end</strong></p>
<p>Looking at the scatterplot above, it is clear that the linear model will provide a poor fit, in fact:</p>
<pre class="r"><code>ss &lt;- sort( sample(1:n, 1e4) )
plot(x[ss], y[ss], col = &quot;grey&quot;)
abline(a = 0, b = reg1D(y, x), col = 2, lwd = 2)</code></pre>
<p><img src="/sc2-2019/rcpp_advanced_III/3_Exercises_files/figure-html/unnamed-chunk-9-1.png" width="672" />
is arguably a pretty poor fit! Let’s try to do better by fitting a polynomial regression such as <span class="math inline">\(\mathbb{E}(y|x) = \beta_0 + \beta_1 x + \beta_2 x^2 + \beta_3 x^3\)</span> (note that we have included an intercept here, despite <span class="math inline">\(y\)</span> being centered. The reason will become clear later on). A multivariate linear regression model, with model matrix <code>X</code>, can be fitted using the following function:</p>
<pre class="r"><code>regMD &lt;- function(y, X){
  
  XtX &lt;- t(X) %*% X
  
  C &lt;- chol(XtX)
  
  b &lt;- backsolve(C, forwardsolve(t(C), t(X) %*% y) )
  
  return(b)
  
}</code></pre>
<p>This function calculates the cholesky decomposition <span class="math inline">\(\bf C^T \bf C = \bf X^T \bf X\)</span> where <span class="math inline">\(\bf C\)</span> is upper triangular. Then <span class="math inline">\(\hat{\bf \beta} = \bf C^{-1}\bf C^{-T}\bf X^T\bf y\)</span>, which is solved by computing <span class="math inline">\(\bf z = \bf C^{-T}\bf X^T\bf y\)</span> by forward-solving the lower-triangular system and then <span class="math inline">\(\hat{\bf \beta} = \bf C^{-1} \bf z\)</span> by back-solving the upper-triangular system. Let’s see whether our function works:</p>
<pre class="r"><code>X &lt;- cbind(1, x, x^2, x^3)

b &lt;- regMD(y, X)

b_lm &lt;- lm(y ~ -1 + X)$coeff

Xu &lt;- cbind(1, 0:47, (0:47)^2, (0:47)^3)
plot(x[ss], y[ss], col = &quot;grey&quot;)
lines(0:47, Xu %*% b, col = 2, lwd = 3)
lines(0:47, Xu %*% b_lm, col = 1, lty = 2)</code></pre>
<p><img src="/sc2-2019/rcpp_advanced_III/3_Exercises_files/figure-html/unnamed-chunk-12-1.png" width="672" />
As one would hope, our solution coincides with the one provided by <code>lm()</code>.</p>
<p><strong>Q2 start</strong> Implement a parallel version of <code>regMD</code> using <code>RcppParallel</code> and compare your function to <code>regMD</code> in terms of exactness and timing. <strong>Q2 end</strong></p>
<p>The polynomial fit is better but we can do even better using local polynomial regression.
This is a function for basic one dimensional local polynomial regression (using a Gaussian kernel):</p>
<pre class="r"><code>regMD_local &lt;- function(y, X, x0, x, h){
  
  w &lt;- dnorm(x0, x, h)
  w &lt;- w / sum(x) * length(y)
  
  wY &lt;- y * sqrt(w)
  wX &lt;- X * sqrt(w)
  wXtwX &lt;- t(wX) %*% wX
  
  C &lt;- chol(wXtwX)
  
  b &lt;- backsolve(C, forwardsolve(t(C), t(wX) %*% wY) )
  
  return(b)
  
}</code></pre>
<p>As always, it is work checking whether our function works by comparing it with <code>lm()</code>:</p>
<pre class="r"><code>b &lt;- regMD_local(y, X, x0 = 35, x = x, h = 5)
b_lm &lt;- lm(y ~ -1 + X, weights = dnorm(35, x, 5))$coeff

plot(x[ss], y[ss], col = &quot;grey&quot;)
lines(0:47, Xu %*% b, col = 2, lwd = 3)
lines(0:47, Xu %*% b_lm, col = 1, lty = 2)
abline(v = 35, lty = 2)</code></pre>
<p><img src="/sc2-2019/rcpp_advanced_III/3_Exercises_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>It seems so. To evaluate our fitted function at several points on the <span class="math inline">\(x\)</span>-axis, we do (NOTE this takes a few minutes to run):</p>
<pre class="r"><code>f &lt;- lapply(0:47, function(.x ) regMD_local(y, X, x0 = .x, x = x, h = 5))

plot(x[ss], y[ss], col = &quot;grey&quot;)
lines(0:47, sapply(1:48, function(ii) Xu[ii, ] %*% f[[ii]]), col = 2, lwd = 3, type = &#39;b&#39;)</code></pre>
<p><img src="/sc2-2019/rcpp_advanced_III/3_Exercises_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p><strong>Q3 start</strong> Implement a parallel version of <code>regMD_local</code> using <code>RcppParallel</code> and compare your function to <code>regMD_local</code> in terms of exactness and timing. <strong>Q3 end</strong></p>
<p><strong>Q4 start</strong> Consider these lines of code:</p>
<pre class="r"><code>  w &lt;- dnorm(x0, x, h)
  w &lt;- w / sum(x)</code></pre>
<p>In principle the weights should sum to one, but for example:</p>
<pre class="r"><code>x &lt;- c(100, 200, 300)
( w &lt;- dnorm(0, x, 1) )
( w &lt;- w / sum(x) ) </code></pre>
<p>as you can see, all the weight are 0! The numerically stable way of computing this is:</p>
<pre class="r"><code>x &lt;- c(100, 200, 300)
lw &lt;- dnorm(0, x, 1, log = TRUE)
mlw &lt;- max(lw)
( w &lt;- exp(lw - mlw) / sum(exp(lw - mlw)) ) </code></pre>
<p>Think about why this solution is preferable and implement a parallel version of it.
<strong>Q4 end</strong></p>
<p><strong>Q4 start</strong> Assume that new data becomes available, that is the model matrix is updated to <span class="math inline">\(\bf X \leftarrow [\bf X_{\text{old}}^T, \bf X_{\text{new}}^T]^T\)</span> (new rows of data have been added). Assuming that you have stored <span class="math inline">\(\bf X_{\text{old}}^T \bf W_{\text{old}} \bf X_{\text{old}}\)</span>, how would you efficiently update your fit? <strong>Q4 end</strong></p>
</div>


  <footer>
  

<script src="//yihui.name/js/math-code.js"></script>
<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script async src="//yihui.name/js/center-img.js"></script>


<script type="text/javascript">
var sc_project=12110974;
var sc_invisible=1;
var sc_security="9b171880";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/12110974/0/9b171880/1/"
alt="Web Analytics"></a></div></noscript>








  


<p align=right>

<a href='https://github.com/mfasiolo/sc2-2019/blob/master/content/rcpp_advanced_III/3_Exercises.Rmd'>View source</a>

|

<a href='https://github.com/mfasiolo/sc2-2019/edit/master/content/rcpp_advanced_III/3_Exercises.Rmd'>Edit source</a>

</p>





<script src="https://utteranc.es/client.js"
        repo="awllee/sc1-2019"
        issue-term="pathname"
        label="utterance"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>



  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">© 2020 <a href="https://mfasiolo.github.io/">Matteo Fasiolo</a></div>
  
  </footer>
  </article>
  
  </body>
</html>

